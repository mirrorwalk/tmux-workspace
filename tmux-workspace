#!/usr/bin/env bash

CONFIG_DIR="$HOME/.config/tmux-workspace"
CONFIG_FILE="$CONFIG_DIR/config.sh"

mkdir -p "$CONFIG_DIR"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Config file not found: $CONFIG_FILE"
    echo "Please create it with the appropriate settings."
    exit 1
fi

source "$CONFIG_FILE"

SHOW_ROOT_DIRECTORIES=${SHOW_ROOT_DIRECTORIES:-true}

if ! command -v fzf &> /dev/null; then
    echo "fzf is not installed. Please install it first."
    exit 1
fi

if ! command -v tmux &> /dev/null; then
    echo "tmux is not installed. Please install it first."
    exit 1
fi

SUBDIRS=()
for ROOT in "${!ROOT_FOLDERS[@]}"; do
    CONFIG_STR="${ROOT_FOLDERS[$ROOT]}"
    IFS=':' read -r MIN_DEPTH MAX_DEPTH <<< "$CONFIG_STR"
    MIN_DEPTH=${MIN_DEPTH:-0}
    MAX_DEPTH=${MAX_DEPTH:-1}

    if [ -d "$ROOT" ]; then
        while IFS= read -r -d '' dir; do
            SUBDIRS+=("$dir")
        done < <(find "$ROOT" -mindepth "$MIN_DEPTH" -maxdepth "$MAX_DEPTH" -type d -print0)
    fi
done

FILTERED_SUBDIRS=()
declare -A SEEN_DIRS
for dir in "${SUBDIRS[@]}"; do
    [[ -n "${SEEN_DIRS[$dir]}" ]] && continue
    SEEN_DIRS["$dir"]=1

    if [[ -n "${ROOT_FOLDERS[$dir]}" ]]; then
        DIR_MIN_DEPTH="${ROOT_FOLDERS[$dir]%%:*}"
        [[ "$DIR_MIN_DEPTH" -ne 0 ]] && continue
    fi

    FILTERED_SUBDIRS+=("$dir")
done

SUBDIRS=("${FILTERED_SUBDIRS[@]}")

if [ ${#SUBDIRS[@]} -eq 0 ]; then
    echo "No subdirectories found in the specified root folders."
    exit 1
fi

SELECTED=$(printf "%s\n" "${SUBDIRS[@]}" | fzf --prompt="Select a directory to open in tmux: " --border)
[[ -z "$SELECTED" ]] && exit 0
[[ ! -d "$SELECTED" ]] && { echo "Selected directory does not exist: $SELECTED"; exit 1; }

SESSION_NAME=$(basename "$SELECTED")

WINDOWS_STR="${CUSTOM_WINDOWS[$SELECTED]}"
if [ -n "$WINDOWS_STR" ]; then
    IFS=':' read -r -a WINDOW_NAMES <<< "$WINDOWS_STR"
else
    WINDOW_NAMES=("main")
fi

if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    FIRST_WINDOW_NAME="${WINDOW_NAMES[0]:-main}"
    tmux new-session -d -s "$SESSION_NAME" -c "$SELECTED" -n "$FIRST_WINDOW_NAME"

    for ((i=1; i<${#WINDOW_NAMES[@]}; i++)); do
        tmux new-window -t "$SESSION_NAME" -c "$SELECTED" -n "${WINDOW_NAMES[$i]}"
    done
fi

tmux select-window -t "$SESSION_NAME:${WINDOW_NAMES[0]:-main}"

if [ -n "$TMUX" ]; then
    tmux switch-client -t "$SESSION_NAME"
else
    tmux attach-session -t "$SESSION_NAME"
fi
